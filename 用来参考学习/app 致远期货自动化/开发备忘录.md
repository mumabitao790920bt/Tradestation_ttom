# 开发备忘录

## 项目概述
致远期货自动化项目 - 4阶段开发计划

## 项目定位
- **主程序**: `D:\yolov5\app 致远期货自动化\GUI_QT.py` - 作为本项目的UI界面主程序
- **基础**: 基于双均线回测系统进行扩展开发
- **目标**: 实现期货自动化交易系统

## 4阶段开发计划

### 第一阶段：数据获取与处理模块（基础建设）
**核心功能：**
- 多数据源行情数据获取系统
- 数据清洗和标准化处理
- 数据存储和管理
- 基础UI界面（品种选择）

**交付成果：** 客户可以看到基础的UI界面，然后可以看到数据

**技术要点：**
- 集成境内数据源（如Wind等）
- 集成境外数据源（如Yahoo Finance、Alpha Vantage等）
- 实现数据缓存和容错机制
- 建立统一的数据接口

### 第二阶段：策略引擎与信号计算（核心算法）
**核心功能：**
- 策略框架设计
- 技术指标计算模块
- 按照用户的策略计算出买卖点算法逻辑

**交付成果：** 客户可以看到买卖点

### 第三阶段：自动化控制与执行（交易执行）
**核心功能：**
- 图像识别和定位
- 模拟人工操作机器人
- 交易指令执行
- 风险控制机制

**交付成果：** 客户可以看到程序自动控制app进行买入或卖出动作

**技术要点：**
- 使用OpenCV进行图像识别
- 自动化操作库（如pyautogui）
- 交易状态监控
- 异常处理和恢复

### 第四阶段：系统集成与优化（完善部署）
**核心功能：**
- 系统集成测试
- 性能优化
- 监控和日志系统
- 用户界面完善
- 部署和运维

**交付成果：** 前边所有功能集合，调试可以部署

**技术要点：**
- 端到端测试
- 性能监控
- 错误日志和报警
- 用户操作指南

## 项目结构
- **主程序**: GUI_QT.py - 项目UI界面主程序
- **基础系统**: 基于双均线回测系统扩展
- **数据源**: 多数据源集成（境内+境外）
- **执行层**: 自动化交易执行

## 当前开发状态
**当前阶段**: 进入第三阶段（自动化控制与执行）
**基础建设**: ✅ 已完成双均线回测系统复刻

### 已完成工作
- [x] 创建复刻脚本
- [x] 分析GUI_QT.py依赖关系  
- [x] 执行复刻操作
- [x] 验证复刻结果
- [x] 建立4阶段开发计划

### 复刻完成情况
✅ **复刻成功完成！** (2025-01-21)

**已复刻的文件和目录：**
- **核心文件 (10/10)**: GUI_QT.py主程序、回测模块、数据处理等
- **数据库文件 (4/4)**: bitcoin_data.db、btc_data.db等
- **目录 (2/2)**: 下载股票历史数据、gupiao_baostock
- **HTML图表文件 (3/3)**: KDJ图表文件

## 第一阶段开发任务（进行中）
**目标**: 数据获取与处理模块（基础建设）

### ✅ 已完成任务
1. **UI界面重构** (2025-01-21)
   - ✅ 修改数据源选项为：指定期货/国内期货/数字货币
   - ✅ 重构品种选择逻辑：恒指期货/国内期货品种/BTC-ETH
   - ✅ 移除不需要的控件：初始资金、均线、下单股数、交易方向
   - ✅ 添加交易周期选择：3/5/10/15/30分钟
   - ✅ 添加聚合按钮："聚合数据并绘图"
   - ✅ 修复代码错误：移除未使用的函数引用

2. **数据聚合功能**
   - ✅ 实现1分钟数据聚合为多分钟K线
   - ✅ 集成远程数据库查询（恒指期货数据）
   - ✅ 支持本地数据库查询（数字货币数据）
   - ✅ 计算M5和M20均线

3. **图表绘制功能**
   - ✅ 直接使用huatu_mz.py的huatucs函数
   - ✅ 实现K线图 + M20/M60均线（按照huatu_mz.py要求）
   - ✅ 支持数据缩放和交互
   - ✅ 生成HTML图表文件

### 🔄 待完成任务
1. **多数据源集成**
   - [ ] 集成境内数据源（Wind等）
   - [ ] 集成境外数据源（Yahoo Finance、Alpha Vantage等）
   - [ ] 建立统一数据接口

2. **功能完善**
   - [ ] 国内期货数据源开发
   - [ ] 数据缓存和容错机制
   - [ ] 错误处理和日志优化

## 第二阶段开发计划（策略运行功能）
**目标**: 实现策略运行和策略图表显示

### 📋 策略运行按钮功能设计
**当前状态**: "策略运行"按钮只显示提示信息
**计划功能**: 点击后运行策略计算并生成策略图表

### 🎯 策略运行工作流程
1. **数据准备**: 使用已聚合的K线数据
2. **策略计算**: 运行策略逻辑，计算买卖信号
3. **图表生成**: 使用 `huatu_mz.py` 生成策略图表
4. **图表显示**: 将策略图表加载到下方WebView中

### 📊 策略图表内容
**使用文件**: `D:\yolov5\app 致远期货自动化\huatu_mz.py`
**图表包含**:
- K线图（基础价格走势）
- 资金曲线（策略收益变化）
- 买卖信号点（策略触发点）
- 其他策略相关指标

### 🔄 界面切换逻辑
- **点击"聚合数据并绘图"** → 显示K线图+均线图（使用huatu_bb.py）
- **点击"策略运行"** → 显示策略图表（使用huatu_mz.py）
- 两个图表可以切换查看，互不影响

### 📝 技术要点
- 策略计算逻辑需要基于现有K线数据
- 需要实现买卖信号的识别和标记
- 资金曲线的计算和绘制
- 图表文件的命名和加载机制

### ✅ 已完成修改
1. **函数参数适配** (2025-01-21)
   - ✅ 修改 `run_backtest` 函数参数，适配GUI界面
   - ✅ 新增 `data_source` 参数：指定期货/国内期货/数字货币
   - ✅ 新增 `period` 参数：交易周期（3/5/10/15/30分钟）
   - ✅ 简化参数：移除 `db_mode`、`db_folder` 等复杂参数

2. **数据源支持**
   - ✅ 指定期货：从远程数据库获取恒指期货数据
   - ✅ 数字货币：支持BTC/ETH本地数据库
   - ✅ 国内期货：预留接口（待开发）

3. **数据聚合功能**
   - ✅ 根据交易周期自动聚合1分钟数据
   - ✅ 支持多周期K线数据生成
   - ✅ 集成到策略计算流程中

4. **List运算函数修复** (2025-01-21)
   - ✅ 创建 `list_subtract()` 函数：处理两个list相减
   - ✅ 创建 `list_divide()` 函数：处理list除以另一个list
   - ✅ 创建 `list_compare()` 函数：处理list与值比较
   - ✅ 修复 `五线差`、`五线比`、`粘合` 计算中的TypeError
   - ✅ 解决 `NthMaxList` 和 `NthMinList` 返回list的运算问题

5. **策略参数可调节化** (2025-01-21)
   - ✅ 创建公共函数 `calculate_strategy_signals()` 统一策略计算逻辑
   - ✅ 添加可调节参数：`粘合阈值` (默认0.0015) 和 `ma4附近阈值` (默认0.002)
   - ✅ 重构三个重复代码段，减少约60行重复代码
   - ✅ 更新所有调用点传递新参数
   - ✅ 为后续GUI界面集成做准备

6. **第二阶段策略与主界面集成** (2025-01-21)
   - ✅ 在GUI界面添加策略参数输入框：粘合阈值、ma4附近阈值
   - ✅ 在GUI界面添加均线参数输入框：jx1-jx5
   - ✅ 实现"策略运行"按钮调用第二阶段策略部分
   - ✅ 实现策略图表显示（包含资金曲线、买卖信号等）
   - ✅ 添加策略自动运行功能（每分钟循环执行）
   - ✅ 添加启动/停止策略自动运行按钮
   - ✅ 根据交易周期动态设置table_name参数
   - ✅ 完成第二阶段策略与主界面的完整集成

### 技术准备
- ✅ GUI_QT.py主程序重构完成
- ✅ 数据处理模块(data_processing.py)
- ✅ 数据下载模块(下载股票历史数据/)
- ✅ 远程数据库集成（恒指期货）
- ✅ 图表绘制功能（pyecharts）
- ✅ 二阶段策略部分.py函数参数适配完成
- ✅ List运算函数库创建完成

## 第三阶段实施计划（自动化控制与执行）
**目标**: 在已登录的网页账户 `fk.crkpk.com/trade/MHI` 上完成自动化下单、查询、撤单等闭环操作，并与策略信号打通。

### 一、页面元素采集与映射 ✅
- ✅ 工具脚本: `D:\yolov5\app 致远期货自动化\通过点击获取网页元素.py`
- ✅ 调整项: 将默认打开网址改为 `https://fk.crkpk.com/trade/MHI`；优先复用本机已登录浏览器用户数据或调试端口附着；保留手动Cookie注入备用。
- ✅ 产出物: 标准化元素映射JSON（统一命名规范，如：`模拟_买涨`、`实盘_买涨`、`模拟_保证金1`、`实盘_保证金1` 等）。

### 二、交易执行适配 ✅
- ✅ 参考脚本: `weex_trader.py`（仅作方法参考，不纳入交付）
- ✅ 实施项: 基于既有方法结构 `_click_element`、`_input_text`、`_get_current_price` 等，适配MHI页面元素与流程，覆盖：买入开多、卖出开空、平多、平空、查询持仓/委托。
- ✅ UI界面优化: 切换模式按钮移至订单设置下方，一次性设置所有参数（模拟/实盘模式 + 订单类型 + 交易模式 + 手数 + 保证金 + 止盈价格）
- ✅ 交易操作优化: 买涨/买跌不再重复设置参数，直接执行交易，提高操作效率
- ✅ 模式逻辑优化: 模拟模式不设置订单类型，只设置元/手数/保证金；实盘模式需要设置市价/元角/手数/保证金
- ✅ 元素映射修复: 修正"市价订单"为"市价"，解决元素查找错误
- ✅ 手数映射修正: 5手→数量4, 8手→数量5, 10手→数量6（模拟和实盘模式）
- ✅ 保证金界面优化: 改为"一档/二档/三档/四档"显示，对应2700/4050/5850/8100
- ✅ 变量未定义错误修复: order_type变量在模拟模式下设置默认值
- ✅ 查询持仓功能修复: 添加持仓列表元素映射，支持模拟和实盘模式查询
- ✅ 交易速度优化: 大幅减少所有操作的等待时间，实现超快速交易
- ✅ 超快速交易器: 创建专门的高速版本，去除所有不必要的等待

### 三、最小闭环联调
- 步骤: 下单 → 二次确认/弹窗 → 查询委托/成交 → 如必要执行撤单 → 校验页面与日志一致性。
- 验收: 形成一次完整下单到结果确认的可重复流程脚本。

### 四、风险控制与保护
- 价格偏移与滑点上限，数量与名义价值上限；
- 二次确认弹窗、冷却时间、超时与失败自动回滚；
- 安全开关: 只读/模拟/实盘三挡，默认只读和模拟。

### 五、运行与集成
- 运行方式: 独立命令行脚本 与 `GUI_QT.py` 中的入口按钮；
- 日志与审计: 保存详细操作日志与关键截图，生成交易审计记录；
- 异常恢复: 页面刷新、元素重查找、会话失效重连。

### 六、里程碑
1) 元素映射完成并评审；2) 基础交易动作跑通；3) 最小闭环通过；4) 风控到位；5) GUI入口可用。

## 重要信息
- 🎯 **主程序**: GUI_QT.py 作为项目UI界面主程序
- 🏗️ **基础**: 基于双均线回测系统进行扩展开发
- 📊 **目标**: 实现期货自动化交易系统
- 🚀 **当前**: 准备开始第一阶段开发
